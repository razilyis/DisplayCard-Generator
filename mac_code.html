<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DisplayCard - Developer Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- コーディング用フォント -->
    <link
        href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=JetBrains+Mono:wght@400;700&family=Source+Code+Pro:wght@400;700&family=Inconsolata:wght@400;700&family=Ubuntu+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --card-width: 91mm;
            --card-height: 55mm;
            --accent-color: #61AFEF;
            --keyword: #C678DD;
            --string: #98C379;
            --comment: #5C6370;
            --bg-color: #282C34;
            --main-font: 'Fira Code', monospace;
        }

        body {
            background-color: #1e1e1e;
            color: #abb2bf;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            font-family: 'Inter', sans-serif;
            padding: 4rem 2rem;
        }

        .tool-container {
            width: 100%;
            max-width: var(--card-width);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #captureArea {
            padding: 0.5rem;
            background-color: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1.5rem;
            width: 100%;
            overflow: hidden;
        }

        /* Desktop Layout Override */
        @media (min-width: 1024px) {
            .tool-container {
                max-width: 1600px;
                display: grid;
                grid-template-columns: 1fr 400px;
                grid-template-areas:
                    "preview filesystem"
                    "preview editor";
                gap: 2rem;
                align-items: start;
            }

            #captureArea {
                grid-area: preview;
                /* Allow JS to set height for scaled card */
                overflow: visible;
                position: sticky;
                top: 2rem;
                display: flex;
                justify-content: center;
                align-items: flex-start;
                padding-top: 2rem;
            }

            .file-system-panel {
                grid-area: filesystem;
                width: 100%;
            }

            .editor-panel {
                grid-area: editor;
                width: 100%;
            }
        }

        /* Mac Window Style Card */
        .card {
            width: var(--card-width);
            height: var(--card-height);
            background-color: var(--bg-color);
            color: #abb2bf;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            border-radius: 6px;
            border: 1px solid #181A1F;
            font-family: var(--main-font);
            /* フォント変数適用 */
            -webkit-font-smoothing: antialiased;
            transform: translateZ(0);
        }

        .title-bar {
            height: 12px;
            background-color: #21252B;
            display: flex;
            align-items: center;
            padding-left: 8px;
            border-bottom: 1px solid #181A1F;
            flex-shrink: 0;
        }

        .window-dots {
            display: flex;
            gap: 4px;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .dot-red {
            background-color: #FF5F56;
        }

        .dot-yellow {
            background-color: #FFBD2E;
        }

        .dot-green {
            background-color: #27C93F;
        }

        .editor-content {
            padding: 6px 12px;
            font-size: 6.5pt;
            line-height: 1.4;
            flex-grow: 1;
            position: relative;
            z-index: 10;
            white-space: pre-wrap;
            word-break: break-word;
            overflow: hidden;
        }

        .code-line {
            display: flex;
            align-items: flex-start;
        }

        .line-num {
            color: #4b5263;
            margin-right: 8px;
            user-select: none;
            text-align: right;
            display: inline-block;
            width: 12px;
            flex-shrink: 0;
        }

        .kw {
            color: var(--keyword);
        }

        .fn {
            color: var(--accent-color);
        }

        .str {
            color: var(--string);
        }

        .cmt {
            color: var(--comment);
            font-style: italic;
        }

        .punc {
            color: #abb2bf;
        }

        .dynamic-text {
            color: var(--accent-color) !important;
        }

        /* Editor Panel */
        .editor-panel {
            background: #252526;
            border-radius: 4px;
            padding: 1.5rem;
            border: 1px solid #333;
            width: 100%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        input[type="text"],
        textarea,
        select {
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            font-family: 'Fira Code', monospace;
            font-size: 10px;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--accent-color);
            outline: none;
        }

        /* Buttons */
        .btn-dark {
            background-color: #333333;
            border: 1px solid #444;
            color: #eee;
            transition: all 0.2s;
        }

        .btn-dark:hover {
            background-color: #444;
        }

        .btn-accent {
            background-color: #007ACC;
            color: white;
            font-weight: 600;
            border: none;
        }

        .btn-accent:hover {
            background-color: #0062A3;
        }

        .color-swatch-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
        }

        .color-dot {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 2px;
            cursor: pointer;
            border: 1px solid #3e3e42;
        }

        .color-dot:hover {
            transform: scale(1.1);
            z-index: 10;
            border-color: #fff;
        }

        .color-dot.active {
            border: 2px solid #fff;
        }

        .loader {
            border: 2px solid #333;
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #exportStatus {
            position: fixed;
            bottom: 20px;
            background: #252526;
            color: #fff;
            padding: 8px 16px;
            border: 1px solid #007ACC;
            font-family: 'Fira Code', monospace;
            font-size: 11px;
            display: none;
            z-index: 1000;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: #3e3e42;
            border-radius: 0;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 10px;
            height: 10px;
            background: #007ACC;
            border-radius: 0;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="w-full max-w-3xl flex justify-between items-center mb-8 px-4 font-mono">
        <a href="index.html" class="text-xs font-bold text-gray-500 hover:text-gray-300 transition">&lt; cd ..</a>
        <h1 class="text-xl font-bold text-gray-400 tracking-wider">./GENERATOR_CODE</h1>
        <div class="w-16"></div>
    </div>

    <div class="tool-container space-y-4">

        <div class="file-system-panel bg-[#252526] p-3 border border-[#333] w-full">
            <label class="block text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-2 font-mono">//
                FILE_SYSTEM</label>
            <div class="grid grid-cols-2 gap-2">
                <button id="exportJsonBtn"
                    class="btn-dark text-[10px] py-2 font-mono flex items-center justify-center gap-1"><span>save(json)</span></button>
                <button id="importJsonBtn"
                    class="btn-dark text-[10px] py-2 font-mono flex items-center justify-center gap-1"><span>load(json)</span></button>
                <input type="file" id="jsonFileInput" accept=".json" class="hidden">
            </div>
        </div>

        <div id="captureArea">
            <div class="card" id="productCard">
                <div class="title-bar">
                    <div class="window-dots">
                        <div class="dot dot-red"></div>
                        <div class="dot dot-yellow"></div>
                        <div class="dot dot-green"></div>
                    </div>
                    <div class="flex-grow text-center text-[5px] text-gray-500 tracking-wider" id="displayTitleLabel">
                        PRODUCT_INFO.JS</div>
                </div>

                <div class="editor-content" id="codeEditorContainer">
                    <!-- Dynamic Content -->
                </div>

                <div id="displayBgTextContainer"
                    class="absolute flex items-end justify-end pointer-events-none select-none overflow-visible"
                    style="bottom: -10%; right: -5%; width: 120%; height: 120%; opacity: 0.05; z-index: 0;">
                    <span id="displayBgText"
                        class="text-[100pt] font-bold tracking-tight uppercase inline-block leading-none whitespace-nowrap text-white"
                        style="padding: 0.5em;">AF</span>
                </div>
            </div>
        </div>

        <div class="editor-panel">
            <div class="flex justify-between items-center mb-6 border-b border-[#333] pb-4">
                <h2 class="text-xs font-mono font-bold text-gray-400 flex items-center gap-2">>> CONFIGURATION</h2>
            </div>

            <div class="space-y-5">
                <!-- Font Selection -->
                <div>
                    <label
                        class="block text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-2 font-mono">TYPEFACE</label>
                    <select id="fontSelect"
                        class="w-full text-xs p-2 border border-[#3e3e42] bg-[#1e1e1e] text-gray-300 font-mono h-8 cursor-pointer">
                        <option value="'Fira Code', monospace">FIRA CODE (LIGATURES)</option>
                        <option value="'JetBrains Mono', monospace">JETBRAINS MONO</option>
                        <option value="'Source Code Pro', monospace">SOURCE CODE PRO</option>
                        <option value="'Inconsolata', monospace">INCONSOLATA</option>
                        <option value="'Ubuntu Mono', monospace">UBUNTU MONO</option>
                    </select>
                </div>

                <!-- Syntax Colors -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label
                            class="block text-[9px] font-bold text-gray-500 uppercase tracking-widest font-mono">SYNTAX_THEME</label>
                    </div>
                    <div class="color-swatch-grid" id="swatchGrid"></div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label
                            class="block text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-1 font-mono">CLASS_NAME
                            (Brand)</label>
                        <input type="text" id="brandNameInput" value="AroundForty" class="w-full text-xs p-2">
                    </div>

                    <div>
                        <label
                            class="block text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-1 font-mono">DOC_COMMENT
                            (Slogan)</label>
                        <textarea id="sloganInput" class="w-full text-xs p-2 h-16 mb-2">DESIGNED FOR THE MATURE MIND.
PRECISION ENGINEERED.</textarea>
                    </div>

                    <div class="p-3 bg-[#1e1e1e] border border-[#333]">
                        <label
                            class="block text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-2 font-mono">BG_WATERMARK</label>
                        <input type="text" id="bgTextInput" value="AF" class="w-full text-xs p-2 mb-3 uppercase">
                        <div class="flex justify-between items-center mb-1">
                            <label
                                class="text-[9px] font-bold text-gray-500 uppercase tracking-widest font-mono">OPACITY</label>
                            <span id="opacityDisplay" class="text-[9px] font-mono text-blue-400">0.05</span>
                        </div>
                        <input type="range" id="opacityInput" min="0" max="0.2" step="0.01" value="0.05" class="w-full">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <!-- Model -->
                        <div>
                            <label
                                class="block text-[8px] font-bold text-gray-600 uppercase tracking-widest mb-1 font-mono">KEY_1</label>
                            <input type="text" id="codeNameLabelInput" value="model"
                                class="w-full text-[10px] p-1 mb-1 font-mono bg-[#333] border-none text-gray-400">
                            <input type="text" id="codeNameInput" value="AroundFortyRB" class="w-full text-xs p-2">
                        </div>
                        <!-- Switch -->
                        <div>
                            <label
                                class="block text-[8px] font-bold text-gray-600 uppercase tracking-widest mb-1 font-mono">KEY_2</label>
                            <input type="text" id="keySwitchLabelInput" value="switch"
                                class="w-full text-[10px] p-1 mb-1 font-mono bg-[#333] border-none text-gray-400">
                            <input type="text" id="keySwitchInput" value="Cherry MX Red" class="w-full text-xs p-2">
                        </div>
                        <!-- Keycaps -->
                        <div>
                            <label
                                class="block text-[8px] font-bold text-gray-600 uppercase tracking-widest mb-1 font-mono">KEY_3</label>
                            <input type="text" id="keyCapsLabelInput" value="keycaps"
                                class="w-full text-[10px] p-1 mb-1 font-mono bg-[#333] border-none text-gray-400">
                            <input type="text" id="keyCapsInput" value="PBT Double-shot" class="w-full text-xs p-2">
                        </div>
                        <!-- Owner -->
                        <div>
                            <label
                                class="block text-[8px] font-bold text-gray-600 uppercase tracking-widest mb-1 font-mono">KEY_4</label>
                            <input type="text" id="ownerLabelInput" value="owner"
                                class="w-full text-[10px] p-1 mb-1 font-mono bg-[#333] border-none text-gray-400">
                            <input type="text" id="ownerInput" value="@User" class="w-full text-xs p-2">
                        </div>
                    </div>
                    <div>
                        <label
                            class="block text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-1 font-mono">WINDOW_TITLE</label>
                        <input type="text" id="titleLabelInput" value="PRODUCT_INFO.JS"
                            class="w-full text-xs p-2 uppercase">
                    </div>
                </div>
            </div>

            <div class="pt-6 border-t border-[#333] mt-6">
                <button id="btnExport"
                    class="w-full py-4 px-4 btn-accent text-xs tracking-widest flex items-center justify-center gap-2 rounded">
                    <span>$ npm run build:png</span>
                </button>
            </div>
        </div>
    </div>

    <div id="exportStatus"></div>

    <script type="text/javascript">
        // Syntax Themes
        const syntaxThemes = [
            { main: "#61AFEF", keyword: "#C678DD", string: "#98C379", label: "Atom One Dark" },
            { main: "#9CDCFE", keyword: "#569CD6", string: "#CE9178", label: "VS Code Dark" },
            { main: "#82AAFF", keyword: "#C792EA", string: "#C3E88D", label: "Material Palenight" },
            { main: "#66D9EF", keyword: "#F92672", string: "#E6DB74", label: "Monokai" },
            { main: "#83AFE5", keyword: "#EADDA0", string: "#42A38C", label: "Nord" },
            { main: "#00FF41", keyword: "#008F11", string: "#003B00", label: "Matrix" },
        ];

        const els = {
            card: document.getElementById('productCard'),
            bgText: document.getElementById('displayBgText'),
            bgTextContainer: document.getElementById('displayBgTextContainer'),
            titleLabel: document.getElementById('displayTitleLabel'),
            container: document.getElementById('codeEditorContainer'),

            // Inputs
            fontSelect: document.getElementById('fontSelect'),
            brandNameInput: document.getElementById('brandNameInput'),
            sloganInput: document.getElementById('sloganInput'),
            bgTextInput: document.getElementById('bgTextInput'),
            opacityInput: document.getElementById('opacityInput'),
            opacityDisplay: document.getElementById('opacityDisplay'),
            titleLabelInput: document.getElementById('titleLabelInput'),

            codeNameLabelInput: document.getElementById('codeNameLabelInput'),
            codeNameInput: document.getElementById('codeNameInput'),

            keySwitchLabelInput: document.getElementById('keySwitchLabelInput'),
            keySwitchInput: document.getElementById('keySwitchInput'),

            keyCapsLabelInput: document.getElementById('keyCapsLabelInput'),
            keyCapsInput: document.getElementById('keyCapsInput'),

            ownerLabelInput: document.getElementById('ownerLabelInput'),
            ownerInput: document.getElementById('ownerInput'),

            btnExport: document.getElementById('btnExport'),
            status: document.getElementById('exportStatus'),
            exportJsonBtn: document.getElementById('exportJsonBtn'),
            importJsonBtn: document.getElementById('importJsonBtn'),
            jsonFileInput: document.getElementById('jsonFileInput'),
            swatchGrid: document.getElementById('swatchGrid')
        };

        const showStatus = (msg, duration = 3000) => {
            els.status.innerText = `>> ${msg}`;
            els.status.style.display = 'block';
            setTimeout(() => els.status.style.display = 'none', duration);
        };

        // Utility: HTML Escape
        function escapeHtml(unsafe) {
            if (!unsafe) return "";
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Render code content dynamically
        const renderCode = () => {
            let line = 1;
            let html = '';

            const brand = escapeHtml(els.brandNameInput.value);

            // Line 1
            html += `<div class="code-line"><span class="line-num">${line++}</span><div><span class="kw">const</span> <span class="fn">Brand</span> <span class="punc">=</span> <span class="kw">new</span> <span class="fn">${brand}</span><span class="punc">();</span></div></div>`;

            // Line 2
            html += `<div class="code-line"><span class="line-num">${line++}</span></div>`;

            // Line 3: Comment Start
            html += `<div class="code-line"><span class="line-num">${line++}</span><span class="cmt">/**</span></div>`;

            // Slogan Lines (Handle multi-line input)
            const sloganLines = els.sloganInput.value.split('\n');
            sloganLines.forEach(text => {
                html += `<div class="code-line"><span class="line-num">${line++}</span><span class="cmt">&nbsp;* ${escapeHtml(text)}</span></div>`;
            });

            // Comment End
            html += `<div class="code-line"><span class="line-num">${line++}</span><span class="cmt">&nbsp;*/</span></div>`;

            // Config Object Start
            html += `<div class="code-line"><span class="line-num">${line++}</span><div><span class="kw">export</span> <span class="kw">const</span> <span class="fn">Config</span> <span class="punc">=</span> <span class="punc">{</span></div></div>`;

            // Config Items
            const configItems = [
                { label: els.codeNameLabelInput.value, val: els.codeNameInput.value },
                { label: els.keySwitchLabelInput.value, val: els.keySwitchInput.value },
                { label: els.keyCapsLabelInput.value, val: els.keyCapsInput.value },
                { label: els.ownerLabelInput.value, val: els.ownerInput.value }
            ];

            configItems.forEach((item, index) => {
                const isLast = index === configItems.length - 1;
                const comma = isLast ? '' : '<span class="punc">,</span>';
                html += `<div class="code-line"><span class="line-num">${line++}</span><div>&nbsp;&nbsp;<span class="fn">${escapeHtml(item.label)}</span><span class="punc">:</span>&nbsp;<span class="str">"${escapeHtml(item.val)}"</span>${comma}</div></div>`;
            });

            // Config Object End
            html += `<div class="code-line"><span class="line-num">${line++}</span><span class="punc">};</span></div>`;

            els.container.innerHTML = html;

            // Update other static elements
            if (els.bgText) els.bgText.innerText = els.bgTextInput.value;
            const opacity = els.opacityInput.value;
            if (els.bgTextContainer) els.bgTextContainer.style.opacity = opacity;
            if (els.opacityDisplay) els.opacityDisplay.innerText = opacity;
            if (els.titleLabel) els.titleLabel.innerText = els.titleLabelInput.value;
        };

        // Font Change Listener
        els.fontSelect.onchange = (e) => {
            document.documentElement.style.setProperty('--main-font', e.target.value);
        };

        // Attach listeners to all inputs
        [
            els.brandNameInput, els.sloganInput, els.opacityInput, els.bgTextInput, els.titleLabelInput,
            els.codeNameLabelInput, els.codeNameInput,
            els.keySwitchLabelInput, els.keySwitchInput,
            els.keyCapsLabelInput, els.keyCapsInput,
            els.ownerLabelInput, els.ownerInput
        ].forEach(el => {
            if (el) el.addEventListener('input', renderCode);
        });

        // Theme Logic
        let currentTheme = syntaxThemes[0];
        const updateTheme = (theme) => {
            currentTheme = theme;
            document.documentElement.style.setProperty('--accent-color', theme.main);
            document.documentElement.style.setProperty('--keyword', theme.keyword);
            document.documentElement.style.setProperty('--string', theme.string);

            document.querySelectorAll('.color-dot').forEach(dot => {
                dot.classList.toggle('active', dot.title === theme.label);
            });
        };

        const initSwatches = () => {
            els.swatchGrid.innerHTML = "";
            syntaxThemes.forEach(theme => {
                const dot = document.createElement('div');
                dot.className = 'color-dot';
                dot.style.background = `conic-gradient(${theme.keyword} 0% 33%, ${theme.main} 33% 66%, ${theme.string} 66% 100%)`;
                dot.title = theme.label;
                dot.onclick = () => updateTheme(theme);
                if (theme.label === currentTheme.label) { dot.classList.add('active'); }
                els.swatchGrid.appendChild(dot);
            });
        };

        // Export/Import Logic
        function getFileName(extension) {
            const base = els.codeNameInput.value.trim() || "DevCard";
            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
            return `DEV_${base}_${timestamp}.${extension}`;
        }

        els.exportJsonBtn.onclick = () => {
            const data = {
                brandName: els.brandNameInput.value, slogan: els.sloganInput.value,
                bgText: els.bgTextInput.value, opacity: els.opacityInput.value,
                titleLabel: els.titleLabelInput.value,
                codeNameLabel: els.codeNameLabelInput.value, codeName: els.codeNameInput.value,
                keySwitchLabel: els.keySwitchLabelInput.value, keySwitch: els.keySwitchInput.value,
                keyCapsLabel: els.keyCapsLabelInput.value, keyCaps: els.keyCapsInput.value,
                ownerLabel: els.ownerLabelInput.value, owner: els.ownerInput.value,
                font: els.fontSelect.value,
                themeLabel: currentTheme.label, exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = getFileName('json');
            link.click();
            URL.revokeObjectURL(url);
            showStatus("CONFIG SAVED");
        };

        els.importJsonBtn.onclick = () => els.jsonFileInput.click();
        els.jsonFileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    applyData(data);
                    showStatus("CONFIG LOADED");
                } catch (err) { showStatus("LOAD FAILED"); }
            };
            reader.readAsText(file);
            e.target.value = '';
        };

        function applyData(data) {
            if (data.brandName) els.brandNameInput.value = data.brandName;
            if (data.slogan) els.sloganInput.value = data.slogan;
            if (data.bgText) els.bgTextInput.value = data.bgText;
            if (data.opacity) {
                els.opacityInput.value = data.opacity;
                els.opacityDisplay.innerText = data.opacity;
            }
            if (data.titleLabel) els.titleLabelInput.value = data.titleLabel;

            if (data.codeNameLabel) els.codeNameLabelInput.value = data.codeNameLabel;
            if (data.codeName) els.codeNameInput.value = data.codeName;

            if (data.keySwitchLabel) els.keySwitchLabelInput.value = data.keySwitchLabel;
            if (data.keySwitch) els.keySwitchInput.value = data.keySwitch;

            if (data.keyCapsLabel) els.keyCapsLabelInput.value = data.keyCapsLabel;
            if (data.keyCaps) els.keyCapsInput.value = data.keyCaps;

            if (data.ownerLabel) els.ownerLabelInput.value = data.ownerLabel;
            if (data.owner) els.ownerInput.value = data.owner;

            if (data.font) {
                els.fontSelect.value = data.font;
                document.documentElement.style.setProperty('--main-font', data.font);
            }

            if (data.themeLabel) {
                const theme = syntaxThemes.find(t => t.label === data.themeLabel);
                if (theme) updateTheme(theme);
            }
            renderCode();
        }

        els.btnExport.onclick = async () => {
            if (typeof html2canvas === 'undefined') return showStatus("INITIALIZING LIB...");
            els.btnExport.disabled = true;
            const originalText = els.btnExport.innerHTML;
            els.btnExport.innerHTML = '<span class="loader"></span> BUILDING...';

            try {
                if (document.fonts && document.fonts.ready) { await document.fonts.ready; }
                const cardRect = els.card.getBoundingClientRect();
                const options = {
                    scale: 6, useCORS: true, backgroundColor: "#282C34",
                    width: cardRect.width, height: cardRect.height, scrollX: 0, scrollY: -window.scrollY,
                    onclone: (clonedDoc) => {
                        const c = clonedDoc.getElementById('productCard');
                        const bgContainer = clonedDoc.getElementById('displayBgTextContainer');
                        const bgText = clonedDoc.getElementById('displayBgText');
                        if (c) {
                            c.style.boxShadow = 'none'; c.style.transform = 'none';
                            c.style.overflow = 'visible'; // Allow full render
                        }
                        if (bgContainer && bgText) {
                            bgContainer.style.width = '200%'; bgContainer.style.height = '200%';
                            bgText.style.display = 'inline-block'; bgText.style.lineHeight = '1';
                            bgText.style.padding = '1em'; bgText.style.margin = '0';
                        }
                    }
                };
                const canvas = await html2canvas(els.card, options);
                const dataUrl = canvas.toDataURL('image/png', 1.0);
                const link = document.createElement('a');
                link.download = getFileName('png');
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showStatus("BUILD SUCCESS");
            } catch (err) {
                console.error("Export failed:", err);
                showStatus("BUILD FAILED");
            } finally {
                els.btnExport.disabled = false;
                els.btnExport.innerHTML = originalText;
            }
        };

        // Context: Responsive & Init
        function adjustCardScale() {
            const card = els.card;
            const container = document.getElementById('captureArea');
            const screenWidth = window.innerWidth;
            const cardWidth = 344;

            // コンテナのパディング等を考慮した利用可能幅
            const availableWidth = container.clientWidth - 32;
            const currentCardWidth = 344; // Base width approx

            // 常にスケール計算を行う（拡大・縮小両対応）
            let scale = availableWidth / currentCardWidth;

            // ただし、モバイルなど狭い画面では縮小のみ、広い画面では拡大も許可するが上限を設ける
            // ここではシンプルに、利用可能幅に合わせてフィットさせる
            // 拡大しすぎを防ぐため最大スケールを制限（例: 2.5倍）
            scale = Math.min(scale, 2.5);

            card.style.transform = `scale(${scale})`;
            card.style.transformOrigin = 'center top';

            // スケール後の高さをコンテナに反映 (影や余白のために少しバッファを追加)
            const height = (currentCardWidth * (55 / 91) * scale) + 50;
            container.style.height = `${height}px`;

            // デスクトップ表示（グリッドレイアウト）の場合、margin-bottomの調整は不要または別途CSSで制御
            if (window.innerWidth < 1024) {
                container.style.marginBottom = '1.5rem';
            } else {
                container.style.marginBottom = '0';
            }
        }

        window.addEventListener('resize', adjustCardScale);
        window.addEventListener('load', adjustCardScale);
        document.fonts.ready.then(adjustCardScale);

        initSwatches();
        renderCode();
    </script>
</body>

</html>