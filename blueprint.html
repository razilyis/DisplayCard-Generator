<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DisplayCard - Blueprint Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- 多様なフォントを一括ロード -->
    <link
        href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Inter:wght@400;700&family=Roboto+Mono:wght@400;700&family=Inconsolata:wght@400;700&family=Orbitron:wght@400;700&family=VT323&family=Anonymous+Pro:wght@400;700&family=Source+Code+Pro:wght@400;700&family=Space+Mono:wght@400;700&family=Courier+Prime:wght@400;700&family=Press+Start+2P&family=Special+Elite&family=Architects+Daughter&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --card-width: 91mm;
            --card-height: 55mm;
            --accent-color: #00FFFF;
            /* Cyan for dimensions */
            --paper-color: #003366;
            /* Classic Blueprint Blue */
            --ink-color: #FFFFFF;
            --grid-line: rgba(255, 255, 255, 0.15);
            --main-font: 'Share Tech Mono', monospace;
            /* Default Font Variable */
        }

        body {
            background-color: #e0e5ec;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            font-family: 'Inter', sans-serif;
            padding: 4rem 2rem;
        }

        .tool-container {
            width: 100%;
            max-width: var(--card-width);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #captureArea {
            padding: 0.5rem;
            background-color: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1.5rem;
            width: 100%;
            overflow: hidden;
        }

        /* Desktop Layout Override */
        @media (min-width: 1024px) {
            .tool-container {
                max-width: 1600px;
                display: grid;
                grid-template-columns: 1fr 400px;
                grid-template-areas:
                    "preview filesystem"
                    "preview editor";
                gap: 2rem;
                align-items: start;
            }

            #captureArea {
                grid-area: preview;
                /* Allow JS to set height for scaled card */
                overflow: visible;
                position: sticky;
                top: 2rem;
                display: flex;
                justify-content: center;
                align-items: flex-start;
                padding-top: 2rem;
            }

            .file-system-panel {
                grid-area: filesystem;
                width: 100%;
            }

            .editor-panel {
                grid-area: editor;
                width: 100%;
            }
        }

        /* Blueprint Card Style */
        .card {
            width: var(--card-width);
            height: var(--card-height);
            background-color: var(--paper-color);
            color: var(--ink-color);
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 51, 102, 0.4);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 8mm;
            /* Slightly reduced padding to fit more content */
            box-sizing: border-box;
            border: 2px solid white;
            /* Outer Border */
            font-family: var(--main-font);
            /* Use Variable */
            -webkit-font-smoothing: antialiased;
            transform: translateZ(0);

            /* Grid Pattern */
            background-image:
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 10mm 10mm;
        }

        /* Technical Fonts */
        .font-tech {
            font-family: var(--main-font);
        }

        /* Dimension Lines */
        .dim-line {
            position: absolute;
            background-color: var(--accent-color);
            opacity: 0.8;
        }

        .dim-line::before,
        .dim-line::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background-color: var(--accent-color);
            border-radius: 50%;
        }

        /* Horizontal Dimension */
        .dim-h {
            height: 1px;
            width: 100%;
            top: 0;
            left: 0;
        }

        .dim-h::before {
            left: 0;
            top: -1.5px;
        }

        .dim-h::after {
            right: 0;
            top: -1.5px;
        }

        /* Vertical Dimension */
        .dim-v {
            width: 1px;
            height: 100%;
            top: 0;
            left: 0;
        }

        .dim-v::before {
            top: 0;
            left: -1.5px;
        }

        .dim-v::after {
            bottom: 0;
            left: -1.5px;
        }

        /* Drawing Block (Title Box) */
        .title-block {
            border: 1px solid var(--ink-color);
            display: flex;
            flex-direction: column;
            background-color: rgba(0, 51, 102, 0.8);
        }

        .tb-row {
            display: flex;
            border-bottom: 1px solid var(--grid-line);
        }

        .tb-row:last-child {
            border-bottom: none;
        }

        .tb-cell {
            padding: 3px 5px;
            border-right: 1px solid var(--grid-line);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 24px;
        }

        .tb-cell:last-child {
            border-right: none;
        }

        .tb-label {
            font-size: 4pt;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            line-height: 1.2;
        }

        .tb-value {
            font-size: 6pt;
            font-weight: bold;
            text-transform: uppercase;
            line-height: 1.4;
            white-space: nowrap;
            overflow: visible;
        }

        /* Dynamic Colors */
        .dynamic-text {
            color: var(--accent-color) !important;
        }

        .dynamic-border {
            border-color: var(--accent-color) !important;
        }

        /* Editor Panel */
        .editor-panel {
            background: #fff;
            border-radius: 4px;
            padding: 1.5rem;
            border: 1px solid #ccc;
            width: 100%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        /* Inputs */
        input[type="text"],
        textarea,
        select {
            background-color: #f0f4f8;
            border: 1px solid #cbd5e0;
            color: #333;
            font-family: 'Share Tech Mono', monospace;
            /* Editor font stays constant */
            font-size: 11px;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            border-color: #003366;
            outline: none;
            background-color: #fff;
        }

        /* Swatches */
        .color-swatch-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
        }

        .color-dot {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 2px;
            cursor: pointer;
            border: 1px solid #ddd;
            transition: all 0.2s;
        }

        .color-dot:hover {
            transform: scale(1.1);
            z-index: 10;
            border-color: #333;
        }

        .color-dot.active {
            border: 2px solid #333;
            box-shadow: 0 0 0 2px #fff inset;
        }

        /* Buttons */
        .btn-blue {
            background-color: #003366;
            color: white;
            border: none;
            font-family: 'Share Tech Mono', monospace;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-blue:hover {
            background-color: #004080;
            box-shadow: 0 4px 12px rgba(0, 51, 102, 0.3);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid #003366;
            color: #003366;
            font-family: 'Share Tech Mono', monospace;
            font-weight: bold;
        }

        .btn-outline:hover {
            background-color: #e6f0ff;
        }

        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #003366;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #exportStatus {
            position: fixed;
            bottom: 20px;
            background: #003366;
            color: #fff;
            padding: 8px 16px;
            border: 1px solid #fff;
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            display: none;
            z-index: 1000;
        }

        /* Slider */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: #cbd5e0;
            border-radius: 0;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 10px;
            height: 10px;
            background: #003366;
            border-radius: 0;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="w-full max-w-3xl flex justify-between items-center mb-8 px-4 font-mono">
        <a href="index.html" class="text-xs font-bold text-gray-500 hover:text-gray-800 transition">&lt;
            RETURN_TO_INDEX</a>
        <h1 class="text-xl font-bold text-gray-700 tracking-wider">PROJECT: BLUEPRINT</h1>
        <div class="w-16"></div>
    </div>

    <div class="tool-container space-y-4">

        <!-- File Save Section -->
        <div class="file-system-panel bg-white p-3 border border-gray-300 w-full shadow-sm">
            <label class="block text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-2 font-mono">
                DATA_MANAGEMENT
            </label>
            <div class="grid grid-cols-2 gap-2">
                <button id="exportJsonBtn" class="btn-outline text-[10px] py-2 flex items-center justify-center gap-1">
                    <span>SAVE_CONFIG</span>
                </button>
                <button id="importJsonBtn" class="btn-outline text-[10px] py-2 flex items-center justify-center gap-1">
                    <span>LOAD_CONFIG</span>
                </button>
                <input type="file" id="jsonFileInput" accept=".json" class="hidden">
            </div>
        </div>

        <!-- Card Preview Area -->
        <div id="captureArea">
            <div class="card" id="productCard">
                <!-- Inner Border Frame -->
                <div class="absolute inset-[4mm] border border-white opacity-50 pointer-events-none"></div>

                <!-- Crosshairs -->
                <div class="absolute top-[4mm] left-[4mm] w-2 h-2 border-t border-l border-white"></div>
                <div class="absolute top-[4mm] right-[4mm] w-2 h-2 border-t border-r border-white"></div>
                <div class="absolute bottom-[4mm] left-[4mm] w-2 h-2 border-b border-l border-white"></div>
                <div class="absolute bottom-[4mm] right-[4mm] w-2 h-2 border-b border-r border-white"></div>

                <!-- Measurement Lines (Decorative) -->
                <div
                    class="absolute top-8 left-[10mm] right-[30mm] h-px bg-white opacity-30 flex items-center justify-center">
                    <span class="bg-[#003366] px-1 text-[5px] text-white">WIDTH_REF_A</span>
                </div>

                <!-- Background Watermark -->
                <div id="displayBgTextContainer"
                    class="absolute flex items-center justify-center pointer-events-none select-none overflow-visible"
                    style="top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); width: 100%; height: 100%; opacity: 0.08; z-index: 0;">
                    <span id="displayBgText"
                        class="text-[90pt] font-tech tracking-widest uppercase inline-block leading-none whitespace-nowrap text-white border-4 border-white p-4 opacity-50"
                        style="border-style: double;">AF</span>
                </div>

                <!-- Content Layout -->
                <div class="z-10 flex flex-col h-full justify-between relative">

                    <!-- Header -->
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[6px] opacity-70 mb-1">PROJECT_TITLE:</p>
                            <h1
                                class="text-2xl font-bold tracking-tight uppercase leading-none border-b border-white pb-1 mb-1 inline-block">
                                <span id="displayBrandName">AroundForty</span>
                            </h1>
                            <p class="text-[6px] dynamic-text">REV. 2.0 // SCHEMATIC_VIEW</p>
                        </div>
                        <div class="text-right">
                            <div class="border border-white px-2 py-1 inline-block">
                                <p class="text-[5px] uppercase mb-0.5">FIG. NO</p>
                                <p class="text-[10px] font-bold leading-none dynamic-text">01-A</p>
                            </div>
                        </div>
                    </div>

                    <!-- Middle: Description with Dimension Lines -->
                    <div class="flex-grow flex items-center relative py-2 pl-4">
                        <!-- Vertical Dimension Line -->
                        <div
                            class="absolute left-0 top-4 bottom-4 w-px bg-white opacity-40 flex flex-col justify-center items-center">
                            <div class="w-1 h-px bg-white absolute top-0 left-[-2px]"></div>
                            <div class="w-1 h-px bg-white absolute bottom-0 left-[-2px]"></div>
                            <span
                                class="bg-[#003366] py-1 text-[4px] text-white rotate-90 whitespace-nowrap">SPEC_DETAIL</span>
                        </div>

                        <div id="displaySlogan" class="text-[8pt] leading-tight opacity-90 whitespace-pre-wrap">DESIGNED
                            FOR THE MATURE MIND.
                            PRECISION ENGINEERED.</div>
                    </div>

                    <!-- Footer: Title Block -->
                    <div class="title-block mt-1">
                        <!-- Row 1 -->
                        <div class="tb-row">
                            <div class="tb-cell w-1/3">
                                <span class="tb-label" id="displayCodeNameLabel">MODEL_ID</span>
                                <span class="tb-value dynamic-text" id="displayCodeName">AroundFortyRB</span>
                            </div>
                            <div class="tb-cell w-1/3">
                                <span class="tb-label" id="displayMfgCodeLabel">MFG_CODE</span>
                                <span class="tb-value" id="displayMfgCode">02AFRB</span>
                            </div>
                            <div class="tb-cell w-1/3">
                                <span class="tb-label" id="displayOwnerLabel">OWNER</span>
                                <span class="tb-value" id="displayOwner">@USER</span>
                            </div>
                        </div>
                        <!-- Row 2 -->
                        <div class="tb-row">
                            <div class="tb-cell w-1/3">
                                <span class="tb-label" id="displayKeySwitchLabel">SWITCH</span>
                                <span class="tb-value" id="displayKeySwitch">CHERRY MX RED</span>
                            </div>
                            <div class="tb-cell w-1/3">
                                <span class="tb-label" id="displayKeyCapsLabel">KEYCAPS</span>
                                <span class="tb-value" id="displayKeyCaps">PBT DOUBLE-SHOT</span>
                            </div>
                            <!-- X Account -->
                            <div class="tb-cell w-1/3">
                                <span class="tb-label" id="displayXLabel">X_ID</span>
                                <span class="tb-value" id="displayXValue">@USER_ID</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Editor Panel -->
        <div class="editor-panel">
            <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-4">
                <h2 class="text-xs font-bold text-gray-500 flex items-center gap-2">>> DRAWING_PARAMETERS</h2>
            </div>

            <div class="space-y-5">
                <!-- Font Selection -->
                <div>
                    <label
                        class="block text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-2 font-mono">TYPEFACE</label>
                    <select id="fontSelect"
                        class="w-full text-xs p-2 border border-gray-300 bg-white font-mono h-8 cursor-pointer">
                        <optgroup label="Technical / Code">
                            <option value="'Share Tech Mono', monospace">SHARE TECH MONO (DEFAULT)</option>
                            <option value="'Roboto Mono', monospace">ROBOTO MONO</option>
                            <option value="'Source Code Pro', monospace">SOURCE CODE PRO</option>
                            <option value="'Inconsolata', monospace">INCONSOLATA</option>
                            <option value="'Anonymous Pro', monospace">ANONYMOUS PRO</option>
                        </optgroup>
                        <optgroup label="Sci-Fi / Retro">
                            <option value="'Orbitron', sans-serif">ORBITRON (SCI-FI)</option>
                            <option value="'Space Mono', monospace">SPACE MONO (GEO)</option>
                            <option value="'VT323', monospace">VT323 (PIXEL)</option>
                            <option value="'Press Start 2P', cursive">PRESS START 2P (8-BIT)</option>
                        </optgroup>
                        <optgroup label="Analog / Draft">
                            <option value="'Courier Prime', monospace">COURIER PRIME (TYPEWRITER)</option>
                            <option value="'Special Elite', cursive">SPECIAL ELITE (GRUNGE)</option>
                            <option value="'Architects Daughter', cursive">ARCHITECTS DAUGHTER (HAND)</option>
                        </optgroup>
                    </select>
                </div>

                <!-- Colors -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label
                            class="block text-[9px] font-bold text-gray-500 uppercase tracking-widest font-mono">MARKER_COLOR</label>
                        <span id="cmykValueDisplay" class="text-[8px] font-mono dynamic-text">CYAN</span>
                    </div>
                    <div class="color-swatch-grid" id="swatchGrid"></div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label
                            class="block text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-1 font-mono">PROJECT_NAME
                            (Brand)</label>
                        <input type="text" id="brandNameInput" value="AroundForty" class="w-full text-xs p-2">
                    </div>

                    <div>
                        <label
                            class="block text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-1 font-mono">SPECIFICATION
                            (Slogan)</label>
                        <textarea id="sloganInput" class="w-full text-xs p-2 h-16 mb-2">DESIGNED FOR THE MATURE MIND.
PRECISION ENGINEERED.</textarea>

                        <div class="flex justify-between items-center mb-1 px-1">
                            <label
                                class="text-[7px] font-bold text-gray-500 uppercase tracking-widest font-mono">FONT_SIZE</label>
                            <span id="sloganSizeDisplay" class="text-[8px] font-mono text-blue-600">8pt</span>
                        </div>
                        <input type="range" id="sloganSizeInput" min="4" max="24" value="8" step="0.5" class="w-full">
                    </div>

                    <div class="p-3 bg-gray-100 border border-gray-200">
                        <label
                            class="block text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-2 font-mono">WATERMARK_STAMP</label>
                        <input type="text" id="bgTextInput" value="AF" class="w-full text-xs p-2 mb-3 uppercase">

                        <div class="flex justify-between items-center mb-1">
                            <label
                                class="text-[9px] font-bold text-gray-500 uppercase tracking-widest font-mono">SIZE</label>
                            <span id="bgTextSizeDisplay" class="text-[9px] font-mono text-blue-600">90pt</span>
                        </div>
                        <input type="range" id="bgTextSizeInput" min="40" max="250" value="90" class="w-full">
                    </div>

                    <!-- Config Keys Section -->
                    <div class="grid grid-cols-2 gap-3">
                        <!-- Model -->
                        <div>
                            <label
                                class="block text-[8px] font-bold text-gray-500 uppercase tracking-widest mb-1 font-mono">BLOCK_LABEL_1</label>
                            <input type="text" id="codeNameLabelInput" value="MODEL_ID"
                                class="w-full text-[10px] p-1 mb-1 font-mono bg-white border border-gray-300 text-gray-400 uppercase">
                            <input type="text" id="codeNameInput" value="AroundFortyRB"
                                class="w-full text-xs p-2 font-mono">
                        </div>
                        <!-- MFG Code -->
                        <div>
                            <label
                                class="block text-[8px] font-bold text-gray-500 uppercase tracking-widest mb-1 font-mono">BLOCK_LABEL_2</label>
                            <input type="text" id="mfgCodeLabelInput" value="MFG_CODE"
                                class="w-full text-[10px] p-1 mb-1 font-mono bg-white border border-gray-300 text-gray-400 uppercase">
                            <input type="text" id="mfgCodeInput" value="02AFRB"
                                class="w-full text-xs p-2 font-mono uppercase">
                        </div>
                        <!-- Owner -->
                        <div>
                            <label
                                class="block text-[8px] font-bold text-gray-500 uppercase tracking-widest mb-1 font-mono">BLOCK_LABEL_3</label>
                            <input type="text" id="ownerLabelInput" value="OWNER"
                                class="w-full text-[10px] p-1 mb-1 font-mono bg-white border border-gray-300 text-gray-400 uppercase">
                            <input type="text" id="ownerInput" value="@USER" class="w-full text-xs p-2 font-mono">
                        </div>
                        <!-- X Account -->
                        <div>
                            <label
                                class="block text-[8px] font-bold text-gray-500 uppercase tracking-widest mb-1 font-mono">BLOCK_LABEL_6</label>
                            <input type="text" id="xLabelInput" value="X_ID"
                                class="w-full text-[10px] p-1 mb-1 font-mono bg-white border border-gray-300 text-gray-400 uppercase">
                            <input type="text" id="xValueInput" value="@USER_ID" class="w-full text-xs p-2 font-mono">
                        </div>
                        <!-- Switch -->
                        <div>
                            <label
                                class="block text-[8px] font-bold text-gray-500 uppercase tracking-widest mb-1 font-mono">BLOCK_LABEL_4</label>
                            <input type="text" id="keySwitchLabelInput" value="SWITCH"
                                class="w-full text-[10px] p-1 mb-1 font-mono bg-white border border-gray-300 text-gray-400 uppercase">
                            <input type="text" id="keySwitchInput" value="CHERRY MX RED"
                                class="w-full text-xs p-2 font-mono">
                        </div>
                        <!-- Keycaps -->
                        <div>
                            <label
                                class="block text-[8px] font-bold text-gray-500 uppercase tracking-widest mb-1 font-mono">BLOCK_LABEL_5</label>
                            <input type="text" id="keyCapsLabelInput" value="KEYCAPS"
                                class="w-full text-[10px] p-1 mb-1 font-mono bg-white border border-gray-300 text-gray-400 uppercase">
                            <input type="text" id="keyCapsInput" value="PBT DOUBLE-SHOT"
                                class="w-full text-xs p-2 font-mono">
                        </div>
                    </div>
                </div>
            </div>

            <div class="pt-6 border-t border-gray-200 mt-6">
                <button id="btnExport"
                    class="w-full py-4 px-4 btn-blue text-xs tracking-widest flex items-center justify-center gap-2 rounded">
                    <span>[ EXPORT BLUEPRINT ]</span>
                </button>
            </div>
        </div>
    </div>

    <div id="exportStatus"></div>

    <script type="text/javascript">
        // Blueprint Accent Colors
        const bpSwatches = [
            { hex: "#00FFFF", label: "CYAN" },
            { hex: "#FF00FF", label: "MAGENTA" },
            { hex: "#FFFF00", label: "YELLOW" },
            { hex: "#FFFFFF", label: "WHITE" },
            { hex: "#00FF00", label: "LIME" },
            { hex: "#FF5555", label: "ALERT RED" }
        ];

        const els = {
            card: document.getElementById('productCard'),
            brandName: document.getElementById('displayBrandName'),
            slogan: document.getElementById('displaySlogan'),
            bgText: document.getElementById('displayBgText'),
            bgTextContainer: document.getElementById('displayBgTextContainer'),

            codeNameLabel: document.getElementById('displayCodeNameLabel'),
            codeName: document.getElementById('displayCodeName'),
            mfgCodeLabel: document.getElementById('displayMfgCodeLabel'),
            mfgCode: document.getElementById('displayMfgCode'),
            ownerLabel: document.getElementById('displayOwnerLabel'),
            owner: document.getElementById('displayOwner'),
            keySwitchLabel: document.getElementById('displayKeySwitchLabel'),
            keySwitch: document.getElementById('displayKeySwitch'),
            keyCapsLabel: document.getElementById('displayKeyCapsLabel'),
            keyCaps: document.getElementById('displayKeyCaps'),
            xLabel: document.getElementById('displayXLabel'),
            xValue: document.getElementById('displayXValue'),

            // Inputs
            fontSelect: document.getElementById('fontSelect'),
            brandNameInput: document.getElementById('brandNameInput'),
            sloganInput: document.getElementById('sloganInput'),
            sloganSizeInput: document.getElementById('sloganSizeInput'),
            sloganSizeDisplay: document.getElementById('sloganSizeDisplay'),
            bgTextInput: document.getElementById('bgTextInput'),
            bgTextSizeInput: document.getElementById('bgTextSizeInput'),
            bgTextSizeDisplay: document.getElementById('bgTextSizeDisplay'),

            codeNameLabelInput: document.getElementById('codeNameLabelInput'),
            codeNameInput: document.getElementById('codeNameInput'),
            mfgCodeLabelInput: document.getElementById('mfgCodeLabelInput'),
            mfgCodeInput: document.getElementById('mfgCodeInput'),
            ownerLabelInput: document.getElementById('ownerLabelInput'),
            ownerInput: document.getElementById('ownerInput'),
            keySwitchLabelInput: document.getElementById('keySwitchLabelInput'),
            keySwitchInput: document.getElementById('keySwitchInput'),
            keyCapsLabelInput: document.getElementById('keyCapsLabelInput'),
            keyCapsInput: document.getElementById('keyCapsInput'),
            xLabelInput: document.getElementById('xLabelInput'),
            xValueInput: document.getElementById('xValueInput'),

            btnExport: document.getElementById('btnExport'),
            status: document.getElementById('exportStatus'),
            exportJsonBtn: document.getElementById('exportJsonBtn'),
            importJsonBtn: document.getElementById('importJsonBtn'),
            jsonFileInput: document.getElementById('jsonFileInput'),
            swatchGrid: document.getElementById('swatchGrid')
        };

        const showStatus = (msg, duration = 3000) => {
            els.status.innerText = `>> ${msg}`;
            els.status.style.display = 'block';
            setTimeout(() => els.status.style.display = 'none', duration);
        };

        // UI Sync
        const syncUI = () => {
            if (els.brandName) els.brandName.innerText = els.brandNameInput.value;
            if (els.slogan) els.slogan.innerText = els.sloganInput.value;

            const sloganSize = els.sloganSizeInput.value;
            if (els.slogan) els.slogan.style.fontSize = `${sloganSize}pt`;
            if (els.sloganSizeDisplay) els.sloganSizeDisplay.innerText = `${sloganSize}pt`;

            if (els.bgText) els.bgText.innerText = els.bgTextInput.value;
            const bgSize = els.bgTextSizeInput.value;
            if (els.bgText) els.bgText.style.fontSize = `${bgSize}pt`;
            if (els.bgTextSizeDisplay) els.bgTextSizeDisplay.innerText = `${bgSize}pt`;

            if (els.codeNameLabel) els.codeNameLabel.innerText = els.codeNameLabelInput.value;
            if (els.codeName) els.codeName.innerText = els.codeNameInput.value;

            if (els.mfgCodeLabel) els.mfgCodeLabel.innerText = els.mfgCodeLabelInput.value;
            if (els.mfgCode) els.mfgCode.innerText = els.mfgCodeInput.value.toUpperCase();

            if (els.ownerLabel) els.ownerLabel.innerText = els.ownerLabelInput.value;
            if (els.owner) els.owner.innerText = els.ownerInput.value;

            if (els.keySwitchLabel) els.keySwitchLabel.innerText = els.keySwitchLabelInput.value;
            if (els.keySwitch) els.keySwitch.innerText = els.keySwitchInput.value.toUpperCase();

            if (els.keyCapsLabel) els.keyCapsLabel.innerText = els.keyCapsLabelInput.value;
            if (els.keyCaps) els.keyCaps.innerText = els.keyCapsInput.value.toUpperCase();

            if (els.xLabel) els.xLabel.innerText = els.xLabelInput.value;
            if (els.xValue) els.xValue.innerText = els.xValueInput.value;
        };

        // Font Change Listener
        els.fontSelect.onchange = (e) => {
            document.documentElement.style.setProperty('--main-font', e.target.value);
        };

        [
            els.brandNameInput, els.sloganInput, els.sloganSizeInput, els.bgTextInput, els.bgTextSizeInput,
            els.codeNameLabelInput, els.codeNameInput,
            els.mfgCodeLabelInput, els.mfgCodeInput,
            els.ownerLabelInput, els.ownerInput,
            els.keySwitchLabelInput, els.keySwitchInput,
            els.keyCapsLabelInput, els.keyCapsInput,
            els.xLabelInput, els.xValueInput
        ].forEach(el => {
            if (el) el.addEventListener('input', syncUI);
        });

        // Theme Logic
        let currentAccentColor = "#00FFFF";
        const updateTheme = (hex, label) => {
            currentAccentColor = hex;
            document.documentElement.style.setProperty('--accent-color', hex);

            document.querySelectorAll('.color-dot').forEach(dot => {
                dot.classList.toggle('active', dot.dataset.hex === hex);
            });
        };

        const initSwatches = () => {
            els.swatchGrid.innerHTML = "";
            bpSwatches.forEach(swatch => {
                const dot = document.createElement('div');
                dot.className = 'color-dot';
                dot.style.backgroundColor = swatch.hex;
                dot.dataset.hex = swatch.hex;
                dot.title = swatch.label;
                dot.onclick = () => updateTheme(swatch.hex, swatch.label);
                if (swatch.hex.toLowerCase() === currentAccentColor.toLowerCase()) { dot.classList.add('active'); }
                els.swatchGrid.appendChild(dot);
            });
        };

        // File name helper
        function getFileName(extension) {
            const base = els.codeNameInput.value.trim() || "Blueprint";
            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
            return `BP_${base}_${timestamp}.${extension}`;
        }

        els.exportJsonBtn.onclick = () => {
            const data = {
                brandName: els.brandNameInput.value, slogan: els.sloganInput.value, sloganSize: els.sloganSizeInput.value,
                bgText: els.bgTextInput.value, bgTextSize: els.bgTextSizeInput.value,
                codeNameLabel: els.codeNameLabelInput.value, codeName: els.codeNameInput.value,
                mfgCodeLabel: els.mfgCodeLabelInput.value, mfgCode: els.mfgCodeInput.value,
                ownerLabel: els.ownerLabelInput.value, owner: els.ownerInput.value,
                keySwitchLabel: els.keySwitchLabelInput.value, keySwitch: els.keySwitchInput.value,
                keyCapsLabel: els.keyCapsLabelInput.value, keyCaps: els.keyCapsInput.value,
                xLabel: els.xLabelInput.value, xValue: els.xValueInput.value,
                font: els.fontSelect.value,
                accentColor: currentAccentColor, exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = getFileName('json');
            link.click();
            URL.revokeObjectURL(url);
            showStatus("CONFIG SAVED");
        };

        els.importJsonBtn.onclick = () => els.jsonFileInput.click();
        els.jsonFileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    applyData(data);
                    showStatus("CONFIG LOADED");
                } catch (err) { showStatus("LOAD FAILED"); }
            };
            reader.readAsText(file);
            e.target.value = '';
        };

        function applyData(data) {
            if (data.brandName) els.brandNameInput.value = data.brandName;
            if (data.slogan) els.sloganInput.value = data.slogan;
            if (data.sloganSize) {
                els.sloganSizeInput.value = data.sloganSize;
                els.sloganSizeDisplay.innerText = data.sloganSize + "pt";
            }
            if (data.bgText) els.bgTextInput.value = data.bgText;
            if (data.bgTextSize) {
                els.bgTextSizeInput.value = data.bgTextSize;
                els.bgTextSizeDisplay.innerText = data.bgTextSize + "pt";
            }
            if (data.codeNameLabel) els.codeNameLabelInput.value = data.codeNameLabel;
            if (data.codeName) els.codeNameInput.value = data.codeName;
            if (data.mfgCodeLabel) els.mfgCodeLabelInput.value = data.mfgCodeLabel;
            if (data.mfgCode) els.mfgCodeInput.value = data.mfgCode;
            if (data.ownerLabel) els.ownerLabelInput.value = data.ownerLabel;
            if (data.owner) els.ownerInput.value = data.owner;
            if (data.keySwitchLabel) els.keySwitchLabelInput.value = data.keySwitchLabel;
            if (data.keySwitch) els.keySwitchInput.value = data.keySwitch;
            if (data.keyCapsLabel) els.keyCapsLabelInput.value = data.keyCapsLabel;
            if (data.keyCaps) els.keyCapsInput.value = data.keyCaps;
            if (data.xLabel) els.xLabelInput.value = data.xLabel;
            if (data.xValue) els.xValueInput.value = data.xValue;

            if (data.font) {
                els.fontSelect.value = data.font;
                document.documentElement.style.setProperty('--main-font', data.font);
            }

            if (data.accentColor) updateTheme(data.accentColor);

            syncUI();
        }

        els.btnExport.onclick = async () => {
            if (typeof html2canvas === 'undefined') return showStatus("INITIALIZING LIB...");
            els.btnExport.disabled = true;
            const originalText = els.btnExport.innerHTML;
            els.btnExport.innerHTML = '<span class="loader"></span> PLOTTING...';

            try {
                if (document.fonts && document.fonts.ready) { await document.fonts.ready; }
                const cardRect = els.card.getBoundingClientRect();

                const options = {
                    scale: 6, useCORS: true, backgroundColor: "#003366", // Blueprint Blue
                    width: cardRect.width, height: cardRect.height, scrollX: 0, scrollY: -window.scrollY,
                    onclone: (clonedDoc) => {
                        const c = clonedDoc.getElementById('productCard');
                        if (c) {
                            c.style.boxShadow = 'none'; c.style.transform = 'none';
                            c.style.overflow = 'visible';
                        }
                        // Fix for watermark rotation and clipping
                        const bgContainer = clonedDoc.getElementById('displayBgTextContainer');
                        const bgText = clonedDoc.getElementById('displayBgText');
                        if (bgContainer && bgText) {
                            bgContainer.style.width = '200%'; bgContainer.style.height = '200%';
                            bgContainer.style.top = '50%'; bgContainer.style.left = '50%';
                            bgText.style.display = 'inline-block'; bgText.style.padding = '1em';
                        }
                        // タイトルブロックの文字見切れ対策
                        const tbValues = clonedDoc.querySelectorAll('.tb-value');
                        tbValues.forEach(val => {
                            val.style.overflow = 'visible';
                            val.style.whiteSpace = 'normal';
                            val.style.lineHeight = '1.4';
                        });
                        const tbCells = clonedDoc.querySelectorAll('.tb-cell');
                        tbCells.forEach(cell => {
                            cell.style.overflow = 'visible';
                            cell.style.height = 'auto';
                        });
                    }
                };

                const canvas = await html2canvas(els.card, options);
                const dataUrl = canvas.toDataURL('image/png', 1.0);
                const link = document.createElement('a');
                link.download = getFileName('png');
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showStatus("PLOT COMPLETE");
            } catch (err) {
                console.error("Export failed:", err);
                showStatus("PLOT FAILED");
            } finally {
                els.btnExport.disabled = false;
                els.btnExport.innerHTML = originalText;
            }
        };

        // Context: Responsive & Init
        function adjustCardScale() {
            const card = els.card;
            const container = document.getElementById('captureArea');
            const screenWidth = window.innerWidth;
            const cardWidth = 344;

            // コンテナのパディング等を考慮した利用可能幅
            const availableWidth = container.clientWidth - 32;
            const currentCardWidth = 344;

            // 常にスケール計算を行う（拡大・縮小両対応）
            let scale = availableWidth / currentCardWidth;

            // ただし、モバイルなど狭い画面では縮小のみ、広い画面では拡大も許可するが上限を設ける
            // ここではシンプルに、利用可能幅に合わせてフィットさせる
            // 拡大しすぎを防ぐため最大スケールを制限（例: 2.5倍）
            scale = Math.min(scale, 2.5);

            card.style.transform = `scale(${scale})`;
            card.style.transformOrigin = 'center top';

            // スケール後の高さをコンテナに反映 (影や余白のために少しバッファを追加)
            const height = (currentCardWidth * (55 / 91) * scale) + 50;
            container.style.height = `${height}px`;

            // デスクトップ表示（グリッドレイアウト）の場合、margin-bottomの調整は不要または別途CSSで制御
            if (window.innerWidth < 1024) {
                container.style.marginBottom = '1.5rem';
            } else {
                container.style.marginBottom = '0';
            }
        }

        window.addEventListener('resize', adjustCardScale);
        window.addEventListener('load', adjustCardScale);
        document.fonts.ready.then(adjustCardScale);

        initSwatches();
        syncUI();
    </script>
</body>

</html>